const WebpackCLI = require('./webpack-cli');
const { core } = require('./utils/cli-flags');
const logger = require('./utils/logger');
const { isCommandUsed } = require('./utils/arg-utils');
const argParser = require('./utils/arg-parser');
const leven = require('leven');
const { bgBlue } = require('colorette')
const console = require('customLog');

process.title = 'webpack-cli';

const runCLI = async (cliArgs) => {
    console.log("🌺 4. 进入 runCLI 函数，参数: ", cliArgs);
    const parsedArgs = argParser(core, cliArgs, true, process.title);
    console.log("🌺 5. 参数解析，解析后的参数: ", parsedArgs);
    const commandIsUsed = isCommandUsed(cliArgs);
    if (commandIsUsed) {
        console.log("🌺 6. 使用命令行保留字命令，停止构建 cli 实例");
        return;
    }

    try {
        // Create a new instance of the CLI object
        console.log("🌺 6. 创建 WebpackCLI 实例");
        const cli = new WebpackCLI();

        // Handle the default webpack entry CLI argument, where instead of doing 'webpack-cli --entry ./index.js' you can simply do 'webpack-cli ./index.js'
        // If the unknown arg starts with a '-', it will be considered an unknown flag rather than an entry
        let entry;

        if (parsedArgs.unknownArgs.length > 0) {
            entry = [];

            console.log("🌺 7. 将不是以 - 开头的命令 push 进 entry 数组");
            parsedArgs.unknownArgs = parsedArgs.unknownArgs.filter((item) => {
                if (item.startsWith('-')) {
                    return true;
                }

                entry.push(item);
                return false;
            });
        }

        if (parsedArgs.unknownArgs.length > 0) {
            console.log("🌺 8. 出现未知错误命令，为错误命令提供修改建议");
            parsedArgs.unknownArgs.forEach(async (unknown) => {
                logger.error(`Unknown argument: ${unknown}`);
                const strippedFlag = unknown.substr(2);
                const { name: suggestion } = core.find((flag) => leven(strippedFlag, flag.name) < 3);
                if (suggestion) {
                    logger.raw(`Did you mean --${suggestion}?`);
                }
            });
            process.exit(2);
        }

        const parsedArgsOpts = parsedArgs.opts;

        if (entry) {
            parsedArgsOpts.entry = entry;
        }

        console.log("🌺 7. 异步执行cli，传入剔除unknownArgs和加入entry后的参数: " , parsedArgsOpts);
        await cli.run(parsedArgsOpts, core);
        console.log('🌺 30. cli.run 执行结束, webpack构建流程结束 🎉');
        console.log(bgBlue('---------------------------------------webpack构建流程结束--------------------------------------'));
    } catch (error) {
        logger.error(error);
        process.exit(2);
    }
};

module.exports = runCLI;
