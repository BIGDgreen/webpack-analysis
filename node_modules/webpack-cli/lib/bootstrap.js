const WebpackCLI = require('./webpack-cli');
const { core } = require('./utils/cli-flags');
const logger = require('./utils/logger');
const { isCommandUsed } = require('./utils/arg-utils');
const argParser = require('./utils/arg-parser');
const leven = require('leven');
const { bgBlue } = require('colorette')
const console = require('customLog');

process.title = 'webpack-cli';

const runCLI = async (cliArgs) => {
    console.log("ðŸŒº 4. è¿›å…¥ runCLI å‡½æ•°ï¼Œå‚æ•°: ", cliArgs);
    const parsedArgs = argParser(core, cliArgs, true, process.title);
    console.log("ðŸŒº 5. å‚æ•°è§£æžï¼Œè§£æžåŽçš„å‚æ•°: ", parsedArgs);
    const commandIsUsed = isCommandUsed(cliArgs);
    if (commandIsUsed) {
        console.log("ðŸŒº 6. ä½¿ç”¨å‘½ä»¤è¡Œä¿ç•™å­—å‘½ä»¤ï¼Œåœæ­¢æž„å»º cli å®žä¾‹");
        return;
    }

    try {
        // Create a new instance of the CLI object
        console.log("ðŸŒº 6. åˆ›å»º WebpackCLI å®žä¾‹");
        const cli = new WebpackCLI();

        // Handle the default webpack entry CLI argument, where instead of doing 'webpack-cli --entry ./index.js' you can simply do 'webpack-cli ./index.js'
        // If the unknown arg starts with a '-', it will be considered an unknown flag rather than an entry
        let entry;

        if (parsedArgs.unknownArgs.length > 0) {
            entry = [];

            console.log("ðŸŒº 7. å°†ä¸æ˜¯ä»¥ - å¼€å¤´çš„å‘½ä»¤ push è¿› entry æ•°ç»„");
            parsedArgs.unknownArgs = parsedArgs.unknownArgs.filter((item) => {
                if (item.startsWith('-')) {
                    return true;
                }

                entry.push(item);
                return false;
            });
        }

        if (parsedArgs.unknownArgs.length > 0) {
            console.log("ðŸŒº 8. å‡ºçŽ°æœªçŸ¥é”™è¯¯å‘½ä»¤ï¼Œä¸ºé”™è¯¯å‘½ä»¤æä¾›ä¿®æ”¹å»ºè®®");
            parsedArgs.unknownArgs.forEach(async (unknown) => {
                logger.error(`Unknown argument: ${unknown}`);
                const strippedFlag = unknown.substr(2);
                const { name: suggestion } = core.find((flag) => leven(strippedFlag, flag.name) < 3);
                if (suggestion) {
                    logger.raw(`Did you mean --${suggestion}?`);
                }
            });
            process.exit(2);
        }

        const parsedArgsOpts = parsedArgs.opts;

        if (entry) {
            parsedArgsOpts.entry = entry;
        }

        console.log("ðŸŒº 7. å¼‚æ­¥æ‰§è¡Œcliï¼Œä¼ å…¥å‰”é™¤unknownArgså’ŒåŠ å…¥entryåŽçš„å‚æ•°: " , parsedArgsOpts);
        await cli.run(parsedArgsOpts, core);
        console.log('ðŸŒº 30. cli.run æ‰§è¡Œç»“æŸ, webpackæž„å»ºæµç¨‹ç»“æŸ ðŸŽ‰');
        console.log(bgBlue('---------------------------------------webpackæž„å»ºæµç¨‹ç»“æŸ--------------------------------------'));
    } catch (error) {
        logger.error(error);
        process.exit(2);
    }
};

module.exports = runCLI;
